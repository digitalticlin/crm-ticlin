
#!/bin/bash

# INSTALA√á√ÉO CHROME SIMPLIFICADA PARA VPS - SINTAXE CORRIGIDA
echo "üöÄ INSTALA√á√ÉO CHROME SIMPLIFICADA - VERS√ÉO CORRIGIDA"
echo "=================================================="
echo "üìÖ Data: $(date)"
echo "üéØ Objetivo: Instalar Chrome rapidamente com sintaxe corrigida"
echo ""

# Configura√ß√µes
LOG_FILE="/tmp/chrome_simple_install.log"

# Fun√ß√£o de log simplificada
log_info() {
    echo "[$(date '+%H:%M:%S')] ‚ÑπÔ∏è $1" | tee -a $LOG_FILE
}

log_success() {
    echo "[$(date '+%H:%M:%S')] ‚úÖ $1" | tee -a $LOG_FILE
}

log_error() {
    echo "[$(date '+%H:%M:%S')] ‚ùå $1" | tee -a $LOG_FILE
}

# Fun√ß√£o para verificar se Chrome j√° est√° instalado
check_existing_chrome() {
    log_info "Verificando se Chrome j√° est√° instalado..."
    
    if command -v google-chrome-stable &> /dev/null; then
        log_success "Google Chrome j√° instalado: $(google-chrome-stable --version)"
        
        log_info "Testando funcionalidade do Chrome existente..."
        if timeout 10s google-chrome-stable --headless --no-sandbox --disable-gpu --dump-dom "data:text/html,<h1>Test</h1>" >/dev/null 2>&1; then
            log_success "Chrome existente funcionando corretamente!"
            return 0
        else
            log_info "Chrome instalado mas com problemas, continuando instala√ß√£o..."
            return 1
        fi
    fi
    
    log_info "Chrome n√£o encontrado, prosseguindo com instala√ß√£o..."
    return 1
}

# Fun√ß√£o para verificar conectividade
check_connectivity() {
    log_info "Verificando conectividade..."
    if timeout 5s ping -c 1 google.com >/dev/null 2>&1; then
        log_success "Conectividade OK"
        return 0
    else
        log_error "Sem conectividade - Abortando"
        return 1
    fi
}

# Fun√ß√£o para atualizar sistema
update_system() {
    log_info "Atualizando lista de pacotes..."
    if timeout 30s apt-get update -y >>$LOG_FILE 2>&1; then
        log_success "Lista de pacotes atualizada"
        return 0
    else
        log_error "Falha ao atualizar lista de pacotes"
        return 1
    fi
}

# Fun√ß√£o para instalar depend√™ncias b√°sicas
install_basic_deps() {
    log_info "Instalando depend√™ncias b√°sicas..."
    if apt-get install -y wget gnupg ca-certificates >>$LOG_FILE 2>&1; then
        log_success "Depend√™ncias b√°sicas instaladas"
        return 0
    else
        log_error "Falha ao instalar depend√™ncias b√°sicas"
        return 1
    fi
}

# M√©todo 1: Download direto do Chrome
method1_direct_download() {
    log_info "M√âTODO 1: Download direto do Google Chrome..."
    cd /tmp || return 1
    
    CHROME_URL="https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb"
    log_info "Baixando Chrome..."
    
    if timeout 60s wget -O google-chrome.deb "$CHROME_URL" >>$LOG_FILE 2>&1; then
        log_success "Download conclu√≠do"
    else
        log_error "Falha no download"
        return 1
    fi
    
    log_info "Instalando Chrome via dpkg..."
    if dpkg -i google-chrome.deb >>$LOG_FILE 2>&1; then
        log_success "Instala√ß√£o dpkg: OK"
        return 0
    else
        log_info "Resolvendo depend√™ncias..."
        apt-get install -f -y >>$LOG_FILE 2>&1
        
        if dpkg -i google-chrome.deb >>$LOG_FILE 2>&1; then
            log_success "Instala√ß√£o corrigida: OK"
            return 0
        else
            log_error "Falha na instala√ß√£o via dpkg"
            return 1
        fi
    fi
}

# M√©todo 2: Reposit√≥rio oficial
method2_repository() {
    log_info "M√âTODO 2: Instala√ß√£o via reposit√≥rio oficial..."
    
    # Adicionar chave e reposit√≥rio
    log_info "Adicionando chave GPG do Google..."
    if wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add - >>$LOG_FILE 2>&1; then
        log_success "Chave GPG adicionada"
    else
        log_error "Falha ao adicionar chave GPG"
        return 1
    fi
    
    echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list
    
    apt-get update -y >>$LOG_FILE 2>&1
    
    if timeout 120s apt-get install -y google-chrome-stable >>$LOG_FILE 2>&1; then
        log_success "Chrome instalado via reposit√≥rio"
        return 0
    else
        log_error "Falha no reposit√≥rio"
        return 1
    fi
}

# M√©todo 3: Chromium fallback
method3_chromium() {
    log_info "M√âTODO 3: Instalando Chromium como alternativa..."
    
    if timeout 60s apt-get install -y chromium-browser >>$LOG_FILE 2>&1; then
        log_success "Chromium instalado"
        
        # Criar link simb√≥lico para compatibilidade
        if [ ! -f "/usr/bin/google-chrome-stable" ]; then
            ln -sf /usr/bin/chromium-browser /usr/bin/google-chrome-stable
            log_info "Link simb√≥lico criado: google-chrome-stable -> chromium-browser"
        fi
        return 0
    else
        log_error "Falha na instala√ß√£o do Chromium"
        return 1
    fi
}

# Fun√ß√£o para instalar depend√™ncias headless
install_headless_deps() {
    log_info "Instalando depend√™ncias headless..."
    
    apt-get install -y \
        libnss3 \
        libatk-bridge2.0-0 \
        libdrm2 \
        libxkbcommon0 \
        libxcomposite1 \
        libxdamage1 \
        libxrandr2 \
        libgbm1 \
        libxss1 \
        libasound2 \
        fonts-liberation \
        libappindicator3-1 \
        xdg-utils >>$LOG_FILE 2>&1
    
    if [ $? -eq 0 ]; then
        log_success "Depend√™ncias headless instaladas"
        return 0
    else
        log_error "Algumas depend√™ncias headless falharam"
        return 1
    fi
}

# Fun√ß√£o para testar Chrome
test_chrome() {
    log_info "Testando instala√ß√£o do Chrome..."
    
    # Detectar Chrome instalado
    CHROME_EXEC=""
    if [ -f "/usr/bin/google-chrome-stable" ]; then
        CHROME_EXEC="/usr/bin/google-chrome-stable"
    elif [ -f "/usr/bin/chromium-browser" ]; then
        CHROME_EXEC="/usr/bin/chromium-browser"
    else
        log_error "Nenhum execut√°vel encontrado"
        return 1
    fi
    
    log_info "Chrome encontrado em: $CHROME_EXEC"
    
    # Teste de vers√£o
    if timeout 10s "$CHROME_EXEC" --version >>$LOG_FILE 2>&1; then
        VERSION=$("$CHROME_EXEC" --version)
        log_success "Vers√£o: $VERSION"
    else
        log_error "Falha no teste de vers√£o"
        return 1
    fi
    
    # Teste headless
    log_info "Testando modo headless..."
    if timeout 15s "$CHROME_EXEC" --headless --no-sandbox --disable-gpu --dump-dom "data:text/html,<h1>Test</h1>" >/dev/null 2>&1; then
        log_success "Modo headless: FUNCIONANDO"
        return 0
    else
        log_info "Testando com argumentos VPS..."
        if timeout 15s "$CHROME_EXEC" --headless --no-sandbox --disable-gpu --disable-dev-shm-usage --disable-setuid-sandbox --single-process --dump-dom "data:text/html,<h1>Test</h1>" >/dev/null 2>&1; then
            log_success "Modo headless com argumentos VPS: FUNCIONANDO"
            return 0
        else
            log_error "Modo headless: FALHOU"
            return 1
        fi
    fi
}

# Fun√ß√£o para configurar vari√°veis de ambiente
configure_environment() {
    log_info "Configurando vari√°veis de ambiente..."
    
    # Detectar caminho do Chrome
    CHROME_PATH=""
    if [ -f "/usr/bin/google-chrome-stable" ]; then
        CHROME_PATH="/usr/bin/google-chrome-stable"
    elif [ -f "/usr/bin/chromium-browser" ]; then
        CHROME_PATH="/usr/bin/chromium-browser"
    fi
    
    if [ -n "$CHROME_PATH" ]; then
        export PUPPETEER_EXECUTABLE_PATH="$CHROME_PATH"
        export CHROME_PATH="$CHROME_PATH"
        export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
        
        # Adicionar ao bashrc
        echo "" >> ~/.bashrc
        echo "# Chrome - Instala√ß√£o Simplificada $(date)" >> ~/.bashrc
        echo "export PUPPETEER_EXECUTABLE_PATH=\"$CHROME_PATH\"" >> ~/.bashrc
        echo "export CHROME_PATH=\"$CHROME_PATH\"" >> ~/.bashrc
        echo "export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true" >> ~/.bashrc
        
        log_success "Vari√°veis configuradas para: $CHROME_PATH"
        return 0
    else
        log_error "N√£o foi poss√≠vel encontrar execut√°vel do Chrome"
        return 1
    fi
}

# EXECU√á√ÉO PRINCIPAL
main() {
    echo "üöÄ INICIANDO INSTALA√á√ÉO CHROME SIMPLIFICADA"
    echo "=========================================="
    
    # Criar arquivo de log
    echo "Log da instala√ß√£o iniciado em $(date)" > $LOG_FILE
    
    # Verificar se Chrome j√° existe e funciona
    if check_existing_chrome; then
        echo ""
        echo "üéâ CHROME J√Å INSTALADO E FUNCIONANDO!"
        echo "===================================="
        configure_environment
        echo "üìã Log completo: $LOG_FILE"
        exit 0
    fi
    
    # Verifica√ß√µes b√°sicas
    if ! check_connectivity; then
        exit 1
    fi
    
    if ! update_system; then
        exit 1
    fi
    
    if ! install_basic_deps; then
        exit 1
    fi
    
    # Tentativa sequencial dos m√©todos de instala√ß√£o
    installation_success=false
    
    # Tentar M√©todo 1
    if method1_direct_download; then
        installation_success=true
    fi
    
    # Se falhou, tentar M√©todo 2
    if [ "$installation_success" = false ]; then
        if method2_repository; then
            installation_success=true
        fi
    fi
    
    # Se falhou, tentar M√©todo 3
    if [ "$installation_success" = false ]; then
        if method3_chromium; then
            installation_success=true
        fi
    fi
    
    # Verificar se algum m√©todo funcionou
    if [ "$installation_success" = false ]; then
        log_error "FALHA: Todos os m√©todos de instala√ß√£o falharam"
        echo ""
        echo "üìã LOG COMPLETO:"
        cat $LOG_FILE
        exit 1
    fi
    
    # Instalar depend√™ncias headless
    install_headless_deps
    
    # Testar instala√ß√£o
    if ! test_chrome; then
        log_error "TESTE: Problemas detectados na instala√ß√£o"
        exit 1
    fi
    
    # Configurar ambiente
    if ! configure_environment; then
        log_error "ERRO: Falha na configura√ß√£o de vari√°veis"
        exit 1
    fi
    
    # Limpeza
    rm -f /tmp/google-chrome.deb
    
    # Relat√≥rio final
    echo ""
    echo "üéâ INSTALA√á√ÉO CHROME SIMPLIFICADA CONCLU√çDA!"
    echo "=========================================="
    
    FINAL_VERSION=""
    if command -v google-chrome-stable &> /dev/null; then
        FINAL_VERSION=$(google-chrome-stable --version 2>/dev/null)
    elif command -v chromium-browser &> /dev/null; then
        FINAL_VERSION=$(chromium-browser --version 2>/dev/null)
    fi
    
    echo "‚úÖ Chrome instalado: $FINAL_VERSION"
    echo "‚úÖ Caminho: $PUPPETEER_EXECUTABLE_PATH"
    echo "‚úÖ Teste headless: PASSOU"
    echo "‚úÖ Vari√°veis configuradas"
    echo ""
    echo "üìã PR√ìXIMOS PASSOS:"
    echo "1. Reiniciar servidor WhatsApp: pm2 restart whatsapp-main-3002"
    echo "2. Testar cria√ß√£o de inst√¢ncia"
    echo ""
    echo "üìä Log completo: $LOG_FILE"
    
    log_success "INSTALA√á√ÉO CHROME SIMPLIFICADA FINALIZADA!"
}

# Executar fun√ß√£o principal
main "$@"
