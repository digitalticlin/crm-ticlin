
#!/bin/bash

# Script DEFINITIVO para corre√ß√£o completa do Puppeteer/Chrome na VPS
echo "üîß CORRE√á√ÉO DEFINITIVA PUPPETEER/CHROME - Resolvendo SingletonLock e Protocol Errors"
echo "==================================================================================="

# 1. PARAR COMPLETAMENTE TODOS OS PROCESSOS
echo "üõë FASE 1: LIMPEZA COMPLETA DE PROCESSOS"
echo "========================================"

echo "üßπ Parando PM2 e matando processos..."
pm2 stop all 2>/dev/null || true
pm2 delete all 2>/dev/null || true

# Matar todos os processos Chrome/Chromium/Node restantes
pkill -f chrome 2>/dev/null || true
pkill -f chromium 2>/dev/null || true  
pkill -f node 2>/dev/null || true
pkill -f whatsapp 2>/dev/null || true

echo "‚è≥ Aguardando processos terminarem completamente..."
sleep 5

# 2. LIMPEZA COMPLETA DE LOCKS E SESS√ïES
echo ""
echo "üßπ FASE 2: LIMPEZA DE LOCKS E SESS√ïES CORROMPIDAS"
echo "================================================="

echo "üóëÔ∏è Removendo SingletonLocks..."
rm -rf /root/whatsapp_instances/sessions/*/SingletonLock 2>/dev/null || true
rm -rf /root/whatsapp_instances/sessions/*/.wwebjs_auth 2>/dev/null || true
rm -rf /root/whatsapp_instances/sessions/*/.wwebjs_cache 2>/dev/null || true

echo "üóëÔ∏è Limpando cache do Chrome..."
rm -rf /root/.cache/google-chrome* 2>/dev/null || true
rm -rf /root/.config/google-chrome* 2>/dev/null || true
rm -rf /root/.cache/chromium* 2>/dev/null || true
rm -rf /root/.config/chromium* 2>/dev/null || true

echo "üóëÔ∏è Limpando temp files..."
rm -rf /tmp/.com.google.Chrome* 2>/dev/null || true
rm -rf /tmp/.org.chromium.Chromium* 2>/dev/null || true

# 3. INSTALAR/VERIFICAR CHROME E DEPEND√äNCIAS
echo ""
echo "üì¶ FASE 3: INSTALA√á√ÉO CHROME E DEPEND√äNCIAS"
echo "==========================================="

echo "üîç Verificando Chrome atual..."
if command -v google-chrome &> /dev/null; then
    echo "‚úÖ Google Chrome encontrado: $(google-chrome --version)"
else
    echo "üì• Instalando Google Chrome..."
    wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add -
    echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list
    apt-get update -y
    apt-get install -y google-chrome-stable
fi

echo "üì¶ Instalando depend√™ncias headless COMPLETAS..."
apt-get install -y \
    libnss3 \
    libatk-bridge2.0-0 \
    libdrm2 \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxrandr2 \
    libgbm1 \
    libxss1 \
    libasound2 \
    libpangocairo-1.0-0 \
    libatk1.0-0 \
    libcairo-gobject2 \
    libgtk-3-0 \
    libgdk-pixbuf2.0-0 \
    fonts-liberation \
    libappindicator3-1 \
    xdg-utils \
    libatspi2.0-0 \
    libu2f-udev \
    libvulkan1 \
    libgl1-mesa-glx \
    libgl1-mesa-dri

echo "üì¶ Atualizando depend√™ncias Node.js..."
npm install puppeteer whatsapp-web.js@latest qrcode node-fetch --save

# 4. BACKUP E APLICAR C√ìDIGO CORRIGIDO
echo ""
echo "üîß FASE 4: APLICANDO C√ìDIGO CORRIGIDO"
echo "====================================="

echo "üíæ Fazendo backup do servidor atual..."
cp vps-server-persistent.js vps-server-backup-puppeteer-definitivo-$(date +%Y%m%d_%H%M%S).js 2>/dev/null || true

echo "üîß Aplicando configura√ß√£o Puppeteer CORRIGIDA..."

# Aplicar patch diretamente no arquivo existente
cat > vps-puppeteer-config-patch.js << 'PATCH_EOF'
// CONFIGURA√á√ÉO PUPPETEER DEFINITIVAMENTE CORRIGIDA

// Detectar Chrome uma √∫nica vez (evitar loops)
let chromePathCache = null;
function getChromePath() {
  if (chromePathCache !== null) {
    return chromePathCache;
  }
  
  const chromePaths = [
    '/usr/bin/google-chrome',
    '/usr/bin/google-chrome-stable',
    '/usr/bin/chromium-browser',
    '/usr/bin/chromium'
  ];
  
  for (const chromePath of chromePaths) {
    try {
      require('fs').accessSync(chromePath);
      console.log(`üåê Chrome encontrado: ${chromePath}`);
      chromePathCache = chromePath;
      return chromePath;
    } catch (error) {
      // Continue procurando
    }
  }
  
  console.log('‚ö†Ô∏è Chrome n√£o encontrado nos caminhos padr√£o');
  chromePathCache = false;
  return null;
}

// CONFIGURA√á√ÉO PUPPETEER CORRIGIDA - Sem SingletonLock
const PUPPETEER_CONFIG = {
  headless: true,
  args: [
    '--no-sandbox',
    '--disable-setuid-sandbox',
    '--disable-dev-shm-usage',
    '--disable-gpu',
    '--no-first-run',
    '--disable-background-timer-throttling',
    '--disable-backgrounding-occluded-windows',
    '--disable-renderer-backgrounding',
    '--disable-extensions',
    '--disable-default-apps',
    '--no-zygote',
    '--single-process',
    '--disable-features=VizDisplayCompositor',
    '--disable-ipc-flooding-protection',
    '--memory-pressure-off',
    '--max_old_space_size=4096',
    '--disable-web-security',
    '--disable-features=TranslateUI',
    '--disable-background-networking',
    '--disable-sync',
    '--metrics-recording-only',
    '--mute-audio',
    '--no-default-browser-check',
    '--disable-gpu-sandbox',
    '--disable-software-rasterizer',
    '--user-data-dir=/tmp/chrome-user-data-' + Date.now(), // CORRE√á√ÉO: user-data √∫nico por inst√¢ncia
    '--disable-session-crashed-bubble',
    '--disable-infobars'
  ],
  ignoreHTTPSErrors: true,
  timeout: 60000,
  executablePath: getChromePath() || undefined
};

// FUN√á√ÉO CORRIGIDA: Inicializa√ß√£o com retry e limpeza
async function initializeWhatsAppClientCorrected(instance, retryCount = 0) {
  const maxRetries = 3;
  
  try {
    console.log(`üöÄ CORRIGIDO: Inicializando ${instance.instanceId} (${retryCount + 1}/${maxRetries + 1})`);
    
    // CORRE√á√ÉO: Limpar cliente anterior completamente
    if (instance.client) {
      try {
        await instance.client.destroy();
        await new Promise(resolve => setTimeout(resolve, 3000)); // Aguardar cleanup
      } catch (error) {
        console.log(`‚ö†Ô∏è Erro ao destruir cliente anterior: ${error.message}`);
      }
      instance.client = null;
    }

    // CORRE√á√ÉO: user-data √∫nico para cada tentativa
    const uniqueUserData = `/tmp/chrome-user-data-${instance.instanceId}-${Date.now()}`;
    const puppeteerConfig = {
      ...PUPPETEER_CONFIG,
      args: [
        ...PUPPETEER_CONFIG.args.filter(arg => !arg.startsWith('--user-data-dir')),
        `--user-data-dir=${uniqueUserData}`
      ]
    };

    const client = new Client({
      authStrategy: new LocalAuth({
        clientId: instance.sessionName,
        dataPath: path.join(PERSISTENCE_DIR, 'sessions')
      }),
      puppeteer: puppeteerConfig
    });

    instance.client = client;
    instance.status = 'initializing';

    const initTimeout = setTimeout(() => {
      console.log(`‚è∞ TIMEOUT: ${instance.instanceId} ap√≥s 90 segundos`);
      if (retryCount < maxRetries) {
        setTimeout(() => initializeWhatsAppClientCorrected(instance, retryCount + 1), 10000);
      } else {
        instance.status = 'failed';
        instance.error = 'Timeout na inicializa√ß√£o';
      }
    }, 90000);

    // Event handlers corrigidos
    client.on('qr', async (qr) => {
      console.log(`üì± QR Code CORRIGIDO gerado para: ${instance.instanceId}`);
      clearTimeout(initTimeout);
      
      const qrcode = require('qrcode');
      const qrBase64 = await qrcode.toDataURL(qr, { scale: 8 });
      
      instance.qrCode = qrBase64;
      instance.status = 'qr_ready';
      
      saveInstancesState();
      
      if (instance.webhookUrl) {
        await sendWebhook(instance.webhookUrl, 'qr.update', instance.instanceId, {
          qrCode: qrBase64
        });
      }
    });

    client.on('ready', async () => {
      console.log(`‚úÖ CORRIGIDO: Cliente pronto: ${instance.instanceId}`);
      clearTimeout(initTimeout);
      instance.status = 'ready';
      instance.qrCode = null;
      
      if (instance.webhookUrl) {
        await sendWebhook(instance.webhookUrl, 'connection.update', instance.instanceId, {
          status: 'connected',
          phone: instance.client?.info?.wid?.user || null,
          profileName: instance.client?.info?.pushname || null
        });
      }
      
      saveInstancesState();
    });

    client.on('authenticated', () => {
      console.log(`üîê CORRIGIDO: Autenticado: ${instance.instanceId}`);
      clearTimeout(initTimeout);
      instance.status = 'authenticated';
      saveInstancesState();
    });

    client.on('auth_failure', (msg) => {
      console.error(`‚ùå CORRIGIDO: Falha autentica√ß√£o: ${instance.instanceId}`, msg);
      clearTimeout(initTimeout);
      instance.status = 'auth_failed';
      if (retryCount < maxRetries) {
        setTimeout(() => initializeWhatsAppClientCorrected(instance, retryCount + 1), 15000);
      }
    });

    client.on('disconnected', (reason) => {
      console.log(`üîå CORRIGIDO: Desconectado: ${instance.instanceId} - ${reason}`);
      clearTimeout(initTimeout);
      instance.status = 'disconnected';
      saveInstancesState();
    });

    console.log(`üîÑ CORRIGIDO: Iniciando cliente: ${instance.instanceId}...`);
    await client.initialize();
    
  } catch (error) {
    console.error(`‚ùå CORRIGIDO: Erro ao inicializar: ${instance.instanceId}`, error.message);
    instance.status = 'error';
    instance.error = error.message;
    
    if (retryCount < maxRetries) {
      console.log(`üîÑ CORRIGIDO: Retry ${retryCount + 1}/${maxRetries} em 20s...`);
      setTimeout(() => initializeWhatsAppClientCorrected(instance, retryCount + 1), 20000);
    }
    
    saveInstancesState();
  }
}

console.log('üîß PATCH PUPPETEER DEFINITIVO APLICADO');
PATCH_EOF

# Aplicar o patch no arquivo principal
echo "üîß Integrando patch definitivo no servidor..."

# Backup da fun√ß√£o original
sed -i '/async function initializeWhatsAppClient/,/^}/c\
// FUN√á√ÉO SUBSTITU√çDA POR VERS√ÉO CORRIGIDA\
async function initializeWhatsAppClient(instance, retryCount = 0) {\
  return initializeWhatsAppClientCorrected(instance, retryCount);\
}' vps-server-persistent.js

# Adicionar as configura√ß√µes corrigidas no final
cat vps-puppeteer-config-patch.js >> vps-server-persistent.js

echo "‚úÖ Patch definitivo aplicado"

# 5. CONFIGURAR VARI√ÅVEIS DE AMBIENTE CORRIGIDAS
echo ""
echo "üåç FASE 5: CONFIGURANDO VARI√ÅVEIS DE AMBIENTE"
echo "============================================="

export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
export PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome
export NODE_ENV=production
export DISPLAY=:99

echo "‚úÖ Vari√°veis configuradas"

# 6. TESTE ISOLADO DO PUPPETEER
echo ""
echo "üß™ FASE 6: TESTE ISOLADO PUPPETEER"
echo "=================================="

echo "üß™ Criando teste isolado..."
cat > teste-puppeteer-isolado.js << 'TEST_EOF'
const puppeteer = require('puppeteer');

(async () => {
  try {
    console.log('üöÄ Testando Puppeteer isoladamente...');
    
    const browser = await puppeteer.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--user-data-dir=/tmp/chrome-test-' + Date.now()
      ],
      executablePath: '/usr/bin/google-chrome'
    });

    const page = await browser.newPage();
    await page.goto('https://www.google.com', { waitUntil: 'networkidle2' });
    
    const title = await page.title();
    console.log(`‚úÖ Puppeteer funcionando! T√≠tulo: ${title}`);
    
    await browser.close();
    console.log('‚úÖ Teste Puppeteer: SUCESSO');
    process.exit(0);
    
  } catch (error) {
    console.error('‚ùå Teste Puppeteer FALHOU:', error.message);
    process.exit(1);
  }
})();
TEST_EOF

echo "üß™ Executando teste isolado..."
if node teste-puppeteer-isolado.js; then
    echo "‚úÖ Puppeteer funcionando corretamente"
else
    echo "‚ùå Puppeteer ainda com problemas"
    exit 1
fi

# 7. REINICIAR SERVIDOR COM CORRE√á√ïES
echo ""
echo "üöÄ FASE 7: REINICIANDO SERVIDOR CORRIGIDO"
echo "========================================="

echo "üîç Verificando sintaxe do arquivo corrigido..."
if node -c vps-server-persistent.js; then
    echo "‚úÖ Sintaxe correta"
else
    echo "‚ùå Erro de sintaxe"
    exit 1
fi

echo "üöÄ Iniciando servidor com Puppeteer DEFINITIVAMENTE corrigido..."
PORT=3002 AUTH_TOKEN="3oOb0an43kLEO6cy3bP8LteKCTxshH8eytEV9QR314dcf0b3" pm2 start vps-server-persistent.js --name whatsapp-main-3002 --time

pm2 save

echo "‚è≥ Aguardando estabiliza√ß√£o (20s)..."
sleep 20

# 8. TESTE ESPEC√çFICO DE CRIA√á√ÉO DE INST√ÇNCIA
echo ""
echo "üß™ FASE 8: TESTE DEFINITIVO"
echo "==========================="

echo "üß™ Testando health check:"
curl -s http://localhost:3002/health | jq '{success, status, version}'

echo ""
echo "üß™ Testando cria√ß√£o de inst√¢ncia com Puppeteer corrigido:"
TEST_INSTANCE="puppeteer_definitivo_$(date +%s)"

create_response=$(curl -s -X POST http://localhost:3002/instance/create \
  -H "Authorization: Bearer 3oOb0an43kLEO6cy3bP8LteKCTxshH8eytEV9QR314dcf0b3" \
  -H "Content-Type: application/json" \
  -d "{\"instanceId\":\"$TEST_INSTANCE\",\"sessionName\":\"$TEST_INSTANCE\"}")

echo "üìã Resposta da cria√ß√£o:"
echo "$create_response" | jq '{success, status, message}'

echo ""
echo "‚è≥ Aguardando 30s para QR Code ser gerado..."
sleep 30

echo "üß™ Verificando se QR Code foi gerado:"
qr_response=$(curl -s http://localhost:3002/instance/$TEST_INSTANCE/qr \
  -H "Authorization: Bearer 3oOb0an43kLEO6cy3bP8LteKCTxshH8eytEV9QR314dcf0b3")

echo "üìã Resposta do QR:"
echo "$qr_response" | jq '{success, status, message}'

echo ""
echo "üßπ Limpando inst√¢ncia de teste:"
curl -s -X DELETE http://localhost:3002/instance/$TEST_INSTANCE \
  -H "Authorization: Bearer 3oOb0an43kLEO6cy3bP8LteKCTxshH8eytEV9QR314dcf0b3" | jq '{success}'

echo ""
echo "üìä Status final:"
pm2 status

echo ""
echo "üéâ CORRE√á√ÉO DEFINITIVA PUPPETEER CONCLU√çDA!"
echo "==========================================="
echo ""
echo "‚úÖ Chrome instalado e testado"
echo "‚úÖ Depend√™ncias headless completas"
echo "‚úÖ SingletonLock resolvido"
echo "‚úÖ Protocol errors corrigidos"
echo "‚úÖ Configura√ß√£o Puppeteer otimizada"
echo "‚úÖ User-data √∫nico por inst√¢ncia"
echo "‚úÖ Retry autom√°tico implementado"
echo ""
echo "üìã PR√ìXIMO PASSO:"
echo "Execute: ./teste-pos-correcoes.sh"
echo ""
echo "üéØ EXPECTATIVA: TODOS os testes devem retornar ‚úÖ"
echo "   Especialmente: QR Code deve aparecer como 'ready'"

# Limpeza
rm -f teste-puppeteer-isolado.js
rm -f vps-puppeteer-config-patch.js
